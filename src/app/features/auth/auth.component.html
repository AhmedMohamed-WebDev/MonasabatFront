<div class="auth-container">
  <div class="container-fluid">
    <div class="row justify-content-center align-items-center min-vh-100">
      <div class="col-12 col-sm-8 col-md-6 col-lg-4">

        <!-- Auth Card -->
        <div class="auth-card card shadow">
          <div class="card-body p-4">

            <!-- Header -->
            <div class="text-center mb-4">
              <h3 class="auth-title mb-2">
                {{ currentStep === 'phone' ? 'Welcome' : 'Verify OTP' }}
              </h3>
              <p class="text-muted small">
                {{ currentStep === 'phone'
                ? 'Enter your phone number to get started'
                : 'Enter the OTP sent to your WhatsApp' }}
              </p>
            </div>

            <!-- Step 1: Phone Entry -->
            <div *ngIf="currentStep === 'phone'" class="phone-step">
              <form (submit)="sendOTP()" class="needs-validation" novalidate>

                <!-- Name Input - Add this before phone input -->
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="name" [(ngModel)]="name" name="name"
                    placeholder="Full Name" (input)="clearError()" [disabled]="isLoading" required minlength="2">
                  <label for="name">Full Name</label>
                </div>

                <!-- Existing Phone Input -->
                <div class="form-floating mb-3">
                  <input type="tel" class="form-control phone-input" id="phone" [(ngModel)]="phone" name="phone"
                    placeholder="Phone Number" (input)="clearError()" (blur)="formatPhoneNumber()"
                    [disabled]="isLoading" required>
                  <label for="phone">Phone Number</label>
                </div>

                <!-- Error Message -->
                <div *ngIf="error" class="alert alert-danger alert-sm mb-3" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  {{ error }}
                </div>

                <!-- Success Message -->
                <div *ngIf="success" class="alert alert-success alert-sm mb-3" role="alert">
                  <i class="bi bi-check-circle-fill me-2"></i>
                  {{ success }}
                </div>

                <!-- Send OTP Button -->
                <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" [disabled]="isLoading || !phone.trim()">

                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </span>

                  <i *ngIf="!isLoading" class="bi bi-whatsapp me-2"></i>
                  {{ isLoading ? 'Sending...' : 'Send OTP via WhatsApp' }}
                </button>

              </form>
            </div>

            <!-- Step 2: OTP + Name Entry -->
            <div *ngIf="currentStep === 'otp'" class="otp-step">

              <!-- Back Button -->
              <button type="button" class="btn btn-link btn-sm p-0 mb-3 back-btn" (click)="goBack()">
                <i class="bi bi-arrow-left me-1"></i>
                Change Phone Number
              </button>

              <!-- Phone Display -->
              <div class="phone-display mb-3">
                <small class="text-muted">OTP sent to:</small>
                <div class="fw-semibold">{{ phone }}</div>
              </div>

              <form (submit)="verifyOTP()" class="needs-validation" novalidate>

                <!-- OTP Input -->
                <div class="form-floating mb-3">
                  <input type="text" class="form-control otp-input text-center" id="otp" [(ngModel)]="otp" name="otp"
                    placeholder="000000" maxlength="6" pattern="[0-9]{6}" (input)="clearError()" [disabled]="isLoading"
                    required>
                  <label for="otp">Enter 6-digit OTP</label>
                </div>

                <!-- Name Input (for new users) -->
                <div *ngIf="isNewUser" class="form-floating mb-3 name-field">
                  <input type="text" class="form-control" id="name" [(ngModel)]="name" name="name"
                    placeholder="Full Name" (input)="clearError()" [disabled]="isLoading" required>
                  <label for="name">Full Name</label>
                  <small class="form-text text-muted">
                    It looks like you're new! Please enter your name.
                  </small>
                </div>

                <!-- Error Message -->
                <div *ngIf="error" class="alert alert-danger alert-sm mb-3" role="alert">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  {{ error }}
                </div>

                <!-- Success Message -->
                <div *ngIf="success" class="alert alert-success alert-sm mb-3" role="alert">
                  <i class="bi bi-check-circle-fill me-2"></i>
                  {{ success }}
                </div>

                <!-- Verify Button -->
                <button type="submit" class="btn btn-primary btn-lg w-100 mb-3"
                  [disabled]="isLoading || !otp.trim() || (isNewUser && !name.trim())">

                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </span>

                  {{ isLoading ? 'Verifying...' : 'Confirm' }}
                </button>

                <!-- Resend OTP -->
                <div class="text-center">
                  <button type="button" class="btn btn-link btn-sm text-decoration-none" (click)="sendOTP()"
                    [disabled]="isLoading">
                    Didn't receive OTP? Resend
                  </button>
                </div>

              </form>
            </div>

          </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-3">
          <small class="text-muted">
            By continuing, you agree to our Terms of Service
          </small>
        </div>

      </div>
    </div>
  </div>
</div>