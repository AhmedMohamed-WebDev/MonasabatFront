<!-- src/app/features/admin/admin-dashboard.component.html -->

<div class="container-fluid p-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-8 d-flex align-items-center gap-3">
      <!-- Add Home button -->
      <button class="btn btn-outline-primary" routerLink="/">
        <i class="bi bi-house-door me-2"></i>{{ 'adminDashboard.header.home' | translate }}
      </button>
      <div>
        <h1 class="text-primary-dark mb-0">{{ 'adminDashboard.header.title' | translate }}</h1>
        <p class="text-muted">{{ 'adminDashboard.header.subtitle' | translate }}</p>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <button class="btn btn-outline-danger" (click)="logout()">
        <i class="bi bi-box-arrow-right me-2"></i>{{ 'adminDashboard.header.logout' | translate }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-accent-gold" role="status">
      <span class="visually-hidden">{{ 'adminDashboard.loading.text' | translate }}</span>
    </div>
    <p class="mt-3 text-muted">{{ 'adminDashboard.loading.message' | translate }}</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error }}
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="stats && !loading">
    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
          <div class="stats-icon bg-primary">
            <i class="bi bi-people"></i>
          </div>
          <div class="stats-content">
            <h3>{{ stats.totalUsers }}</h3>
            <p>{{ 'adminDashboard.stats.cards.users.title' | translate }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
          <div class="stats-icon bg-success">
            <i class="bi bi-shop"></i>
          </div>
          <div class="stats-content">
            <h3>{{ stats.totalSuppliers }}</h3>
            <p>{{ 'adminDashboard.stats.cards.suppliers.title' | translate }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
          <div class="stats-icon bg-info">
            <i class="bi bi-calendar-event"></i>
          </div>
          <div class="stats-content">
            <h3>{{ stats.totalBookings }}</h3>
            <p>{{ 'adminDashboard.stats.cards.bookings.title' | translate }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stats-card">
          <div class="stats-icon bg-warning">
            <i class="bi bi-currency-dollar"></i>
          </div>
          <div class="stats-content">
            <h3>${{ stats.totalRevenue }}</h3>
            <p>{{ 'adminDashboard.stats.cards.revenue.title' | translate }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Stats Row -->
    <div class="row mb-4">
      <div class="col-lg-4 col-md-6 mb-3">
        <div class="detail-card">
          <h5 class="text-primary-dark">{{ 'adminDashboard.stats.details.bookingStatus.title' | translate }}</h5>
          <div class="stat-item">
            <span class="text-success">{{ 'adminDashboard.stats.details.bookingStatus.confirmed' | translate }}:</span>
            <strong>{{ stats.confirmedBookings }}</strong>
          </div>
          <div class="stat-item">
            <span class="text-danger">{{ 'adminDashboard.stats.details.bookingStatus.cancelled' | translate }}:</span>
            <strong>{{ stats.cancelledBookings }}</strong>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-md-6 mb-3">
        <div class="detail-card">
          <h5 class="text-primary-dark">{{ 'adminDashboard.stats.details.services.title' | translate }}</h5>
          <div class="stat-item">
            <span class="text-info">{{ 'adminDashboard.stats.details.services.total' | translate }}:</span>
            <strong>{{ stats.totalServices }}</strong>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-md-12 mb-3" *ngIf="stats.topCategories.length > 0">
        <div class="detail-card">
          <h5 class="text-primary-dark">{{ 'adminDashboard.stats.details.topCategories.title' | translate }}</h5>
          <div *ngFor="let category of stats.topCategories" class="stat-item">
            <span class="text-muted">{{ 'categories.' + category._id.toLowerCase() | translate }}:</span>
            <strong>{{ category.count }}</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="card">
      <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'overview'" (click)="selectTab('overview')">
              {{ 'adminDashboard.tabs.overview' | translate }}
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link position-relative" [class.active]="selectedTab === 'requests'"
              (click)="selectTab('requests')">
              {{ 'adminDashboard.tabs.joinRequests' | translate }}
              <span *ngIf="getPendingRequests().length > 0"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ getPendingRequests().length }}
              </span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'messages'" (click)="selectTab('messages')">
              {{ 'adminDashboard.tabs.contactMessages' | translate }}
              <span *ngIf="getUnreadContactMessagesCount() > 0" class="badge bg-danger ms-2">
                {{ getUnreadContactMessagesCount() }}
              </span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" [class.active]="selectedTab === 'locked'" (click)="selectTab('locked')">
              {{ 'adminDashboard.tabs.lockedSuppliers' | translate }}
              <span *ngIf="stats?.lockedSuppliers?.length" class="badge bg-danger ms-2">
                {{ stats.lockedSuppliers.length }}
              </span>
            </button>
          </li>
        </ul>
      </div>

      <div class="card-body">
        <!-- Overview Tab -->
        <div *ngIf="selectedTab === 'overview'">
          <h5 class="text-primary-dark mb-3">{{ 'adminDashboard.overview.title' | translate }}</h5>
          <div class="row">
            <div class="col-md-6">
              <div class="overview-item">
                <h6>{{ 'adminDashboard.overview.userManagement.title' | translate }}</h6>
                <p class="text-muted">
                  {{ 'adminDashboard.overview.userManagement.description' | translate: {
                  totalUsers: stats.totalUsers,
                  totalSuppliers: stats.totalSuppliers
                  } }}
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="overview-item">
                <h6>{{ 'adminDashboard.overview.performance.title' | translate }}</h6>
                <p class="text-muted">
                  {{ 'adminDashboard.overview.performance.description' | translate: {
                  revenue: stats.totalRevenue,
                  bookings: stats.confirmedBookings
                  } }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Join Requests Tab -->
        <div *ngIf="selectedTab === 'requests'">
          <h5 class="text-primary-dark mb-3">{{ 'adminDashboard.requests.title' | translate }}</h5>

          <!-- Pending Requests -->
          <div *ngIf="getPendingRequests().length > 0" class="mb-4">
            <h6 class="text-warning mb-3">
              <i class="bi bi-clock me-2"></i>
              {{ 'adminDashboard.requests.pending.title' | translate }}
              ({{ 'adminDashboard.requests.pending.count' | translate: { count: getPendingRequests().length } }})
            </h6>
            <div class="row">
              <div *ngFor="let request of getPendingRequests()" class="col-lg-6 mb-3">
                <div class="request-card border-warning">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">{{ request.name }}</h6>
                    <span [class]="getStatusBadgeClass(request.status)">
                      {{ 'adminDashboard.requests.status.' + request.status | translate }}
                    </span>
                  </div>
                  <p class="mb-1">
                    <strong>{{ 'adminDashboard.requests.details.phone' | translate }}:</strong>
                    {{ request.phone }}
                  </p>
                  <p class="mb-1" *ngIf="request.serviceType">
                    <strong>{{ 'adminDashboard.requests.details.service' | translate }}:</strong>
                    {{ 'categories.' + request.serviceType | translate }}
                  </p>
                  <p class="mb-1" *ngIf="request.city">
                    <strong>{{ 'adminDashboard.requests.details.city' | translate }}:</strong>
                    {{ 'cities.' + request.city.toLowerCase() | translate }}
                  </p>

                  <!-- Action Buttons -->
                  <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-success btn-sm" (click)="approveRequest(request)">
                      <i class="bi bi-check-lg me-1"></i>
                      {{ 'adminDashboard.requests.actions.approve' | translate }}
                    </button>
                    <button class="btn btn-danger btn-sm" (click)="rejectRequest(request)">
                      <i class="bi bi-x-lg me-1"></i>
                      {{ 'adminDashboard.requests.actions.reject' | translate }}
                    </button>
                    <button class="btn btn-info btn-sm" (click)="markAsReviewed(request)">
                      <i class="bi bi-eye me-1"></i>
                      {{ 'adminDashboard.requests.actions.review' | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- All Other Requests -->
          <div *ngIf="joinRequests.length > getPendingRequests().length">
            <h6 class="text-muted mb-3">{{ 'adminDashboard.requests.history.title' | translate }}</h6>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>{{ 'adminDashboard.requests.table.name' | translate }}</th>
                    <th>{{ 'adminDashboard.requests.table.phone' | translate }}</th>
                    <th>{{ 'adminDashboard.requests.table.serviceType' | translate }}</th>
                    <th>{{ 'adminDashboard.requests.table.city' | translate }}</th>
                    <th>{{ 'adminDashboard.requests.table.status' | translate }}</th>
                    <th>{{ 'adminDashboard.requests.table.date' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let request of joinRequests">
                    <td>{{ request.name }}</td>
                    <td>{{ request.phone }}</td>
                    <td>{{ request.serviceType ? ('categories.' + request.serviceType.toLowerCase() | translate) : 'N/A'
                      }}</td>
                    <td>{{ request.city || 'N/A' }}</td>
                    <td>
                      <span [class]="getStatusBadgeClass(request.status)">
                        {{ 'adminDashboard.requests.status.' + request.status | translate }}
                      </span>
                    </td>
                    <td>{{ request.createdAt | date:'short' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- No Requests State -->
          <div *ngIf="joinRequests.length === 0" class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="text-muted mt-3">{{ 'adminDashboard.requests.history.empty.title' | translate }}</h5>
            <p class="text-muted">{{ 'adminDashboard.requests.history.empty.message' | translate }}</p>
          </div>
        </div>

        <!-- Contact Messages Tab -->
        <div class="tab-pane fade" [class.show]="selectedTab === 'messages'"
          [class.active]="selectedTab === 'messages'">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">{{ 'adminDashboard.tabs.contactMessages' | translate }}</h5>
            <button *ngIf="getUnreadContactMessagesCount() > 0" class="btn btn-sm btn-outline-success"
              (click)="markAllContactMessagesAsRead()">
              <i class="bi bi-check-all me-1"></i>
              {{ 'adminDashboard.contactMessages.markAllRead' | translate }}
            </button>
          </div>

          <div *ngIf="contactMessages.length === 0" class="text-center p-4">
            <i class="bi bi-inbox fs-1 text-muted"></i>
            <p class="text-muted mt-2">{{ 'adminDashboard.contactMessages.noMessages' | translate }}</p>
          </div>

          <div *ngIf="contactMessages.length > 0" class="table-responsive contact-messages-table">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>{{ 'adminDashboard.contactMessages.table.name' | translate }}</th>
                  <th>{{ 'adminDashboard.contactMessages.table.email' | translate }}</th>
                  <th>{{ 'adminDashboard.contactMessages.table.message' | translate }}</th>
                  <th>{{ 'adminDashboard.contactMessages.table.date' | translate }}</th>
                  <th>{{ 'adminDashboard.contactMessages.table.status' | translate }}</th>
                  <th>{{ 'adminDashboard.contactMessages.table.actions' | translate }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let message of contactMessages" [class.table-light]="message.status === 'read'"
                  (click)="markContactMessageAsRead(message._id)">
                  <td>
                    <strong>{{ message.name }}</strong>
                  </td>
                  <td>{{ message.email }}</td>
                  <td>
                    <div class="message-preview">
                      {{ message.message.length > 100 ? (message.message | slice:0:100) + '...' : message.message }}
                    </div>
                  </td>
                  <td>{{ message.createdAt | date:'short' }}</td>
                  <td>
                    <span [class]="message.status === 'pending' ? 'badge bg-warning' : 'badge bg-success'">
                      {{ message.status === 'pending' ? ('adminDashboard.contactMessages.status.pending' | translate) :
                      ('adminDashboard.contactMessages.status.read' | translate) }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary"
                      (click)="$event.stopPropagation(); markContactMessageAsRead(message._id)"
                      *ngIf="message.status === 'pending'">
                      <i class="bi bi-check me-1"></i>
                      {{ 'adminDashboard.contactMessages.actions.markRead' | translate }}
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Locked Suppliers Tab -->
        <div *ngIf="selectedTab === 'locked'">
          <h5 class="text-primary-dark mb-3">
            <i class="bi bi-lock me-2"></i>
            {{ 'adminDashboard.locked.title' | translate }}
          </h5>

          <!-- Locked Suppliers Table -->
          <div class="table-responsive" *ngIf="stats?.lockedSuppliers?.length">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>{{ 'adminDashboard.locked.table.name' | translate }}</th>
                  <th>{{ 'adminDashboard.locked.table.phone' | translate }}</th>
                  <th>{{ 'adminDashboard.locked.table.category' | translate }}</th>
                  <th>{{ 'adminDashboard.locked.table.contacts' | translate }}</th>
                  <th>{{ 'adminDashboard.locked.table.lockDate' | translate }}</th>
                  <th>{{ 'adminDashboard.locked.table.actions' | translate }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let supplier of stats.lockedSuppliers">
                  <td>{{ supplier.name }}</td>
                  <td>{{ supplier.phone }}</td>
                  <td>{{ supplier.category }}</td>
                  <td>
                    <span class="badge bg-warning">
                      {{ supplier.contactCount }}/50
                    </span>
                  </td>
                  <td>{{ supplier.lockDate | date:'short' }}</td>
                  <td>
                    <button class="btn btn-sm btn-success" (click)="unlockSupplier(supplier._id)"
                      [disabled]="unlockingSupplier === supplier._id">
                      <i class="bi bi-unlock me-1"></i>
                      <span *ngIf="unlockingSupplier === supplier._id">
                        <i class="spinner-border spinner-border-sm me-1"></i>
                        {{ 'common.processing' | translate }}
                      </span>
                      <span *ngIf="unlockingSupplier !== supplier._id">
                        {{ 'adminDashboard.locked.actions.unlock' | translate }}
                      </span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- No Locked Suppliers State -->
          <div *ngIf="!stats?.lockedSuppliers?.length" class="text-center py-5">
            <i class="bi bi-shield-check display-1 text-muted"></i>
            <h5 class="text-muted mt-3">{{ 'adminDashboard.locked.empty.title' | translate }}</h5>
            <p class="text-muted">{{ 'adminDashboard.locked.empty.message' | translate }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>